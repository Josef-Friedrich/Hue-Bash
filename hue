#! /bin/bash



CONFIG_FILE="/etc/hue/hue.ini"

if [ -f $CONFIG_FILE ]; then
  source $CONFIG_FILE
else
  echo "hue.ini file was not found. Create hue.ini file in /etc/hue/hue.ini."
fi

while getopts ":djts" OPT; do

  case $OPT in
    d)
      DEBUG=1
      echo "debug mode" >&2
      ;;

    j)
      JQDEBUG=1
      echo "debug mode with jq" >&2
      ;;

    t)
      TEXTDEBUG=1
      echo "debug mode with text" >&2
      ;;

    s)
      JSONDEBUG=1
      echo "json debug mode" >&2
      ;;

    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;

    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;

  esac
done

shift $((OPTIND-1))

##
# Print out a short help text.
##
function _help {
  echo "Usage: hue
  - help
  - set <lights> <attributes>
  - get <lights>
  - alert <lights>"
}

##
# Execute the http call over curl.
#
# - $1 = Http request: PUT, GET
# - $2 = path
# - $3 = json output
##
function _call {
  if [ -n "$3" ]; then
    DATA="--data $3"

    if [ $JSONDEBUG ]; then
      echo $3
    fi
  fi

  curl --silent --request $1 $DATA http://$IP/api/$USERNAME/$2 | _output
}

##
# Stop all hue processes.
##
function _stop {
  PIDS_FILE="/var/run/hue.pids"

  for PID in $(cat $PIDS_FILE); do
    kill $PID > /dev/null
  done

  > $PIDS_FILE
}

##
# Stop all hue processes and reset to default color.
##
function _reset {
  _stop
  _set all $DEFAULT
}

##
# Print out the ip adresse and the hue username.
##
function _debug {
  echo "IP: $IP"
  echo "USERNAME: $USERNAME"
}

##
# Process the json string.
##
function _process_json {

  while true ; do
    case "$1" in

      on)
        VALUES+=("\"on\":true")
        shift 1
        ;;

      off)
        VALUES+=("\"on\":false")
        shift 1
        ;;

      b|bri)
        VALUES+=("\"bri\":$2")
        shift 2
        ;;

      h|hue)
        VALUES+=("\"hue\":$2")
        shift 2
        ;;

      s|sat)
        VALUES+=("\"sat\":$2")
        shift 2
        ;;

      x)
        X=$2
        shift 2
        ;;

      y)
        Y=$2
        shift 2
        ;;

      c|ct)
        VALUES+=("\"ct\":$2")
        shift 2
        ;;

      a|alert)
        VALUES+=("\"alert\":\"$2\"")
        shift 2
        ;;

      e|effect)
        VALUES+=("\"effect\":\"$2\"")
        shift 2
        ;;

      t|transitiontime)
        VALUES+=("\"transitiontime\":$2")
        shift 2
        ;;

      *)
        break
        ;;
    esac
  done

  if [ $X ] && [ $Y ]; then
    VALUES+=("\"xy\":[$X,$Y]")
  fi

  STATE=$(printf ",%s" "${VALUES[@]}")
  STATE=${STATE:1}

  echo "{$STATE}"
}

##
# Set light state.
#
# $1 = Lights
# $@ = Light attributes
##
function _set {
  LIGHTS="$1"
  shift

  JSON=$(_process_json "$@")

  if [ "$LIGHTS" == "all" ]; then

    _call PUT groups/0/action $JSON

  else

    LIGHTS=$(echo "$LIGHTS" | tr "," "\n")

    for LIGHT in $LIGHTS; do
      _call PUT lights/$LIGHT/state "$JSON"
    done

  fi
}

##
# Set light state with tokens.
#
# $1 = Lights
# $2 = Token
##
function _set_token {
  LIGHTS="$1"
  TOKEN="$2"

  _set $LIGHTS ${!TOKEN}
}

##
# Get the state of the lights.
#
# $1 Lights
##
function _get {
  LIGHTS="$1"
  shift

  #DEBUG=1
  JQDEBUG=1

  if [ "$LIGHTS" == "all" ]; then

    _call GET lights

  else

    LIGHTS=$(echo "$LIGHTS" | tr "," "\n")

    for LIGHT in $LIGHTS; do
      _call GET lights/$LIGHT
    done

  fi
}

##
# Perform one breathe cycle.
#
# $1 = Lights
##
function _alert {
  LIGHTS="$1"
  shift

  if [ "$LIGHTS" == "all" ]; then

    _call PUT groups/0/action '{"alert":"select"}'

  else

    LIGHTS=$(echo "$LIGHTS" | tr "," "\n")

    for LIGHT in $LIGHTS; do
      _call PUT lights/$LIGHT/state '{"alert":"select"}'
    done

  fi
}

##
# Print out debug output in three modes:
#
# - normal
# - over jq
# - formatted text output (not working yet)
##
function _output {
  read OUTPUT

  if [ $DEBUG ]; then
    echo $OUTPUT
  fi

  if [ $JQDEBUG ]; then
    echo $OUTPUT | jq '.'
  fi

  if [ $TEXTDEBUG ]; then

    # Hue and Saturation
    HUE=$(echo $OUTPUT | jq '.state.hue')
    SATURATION=$(echo $OUTPUT | jq '.state.sat')

    # XY
    X=$(echo $OUTPUT | jq '.state.xy[0]')
    Y=$(echo $OUTPUT | jq '.state.xy[1]')

    # COLORTEMPERATURE
    COLORTEMPERATURE=$(echo $OUTPUT | jq '.state.ct')

    BRIGHTNESS=$(echo $OUTPUT | jq '.state.bri')

    echo "$HUE;$SATURATION;$X;$Y;$COLORTEMPERATURE"
  fi
}

case "$1" in
  help)
    _help
  ;;

  set)
    shift
    _set $@
  ;;

  token)
    shift
    _set_token $@
  ;;

  get)
    shift
    _get $@
  ;;

  alert)
    shift
    _alert $@
  ;;

  reset)
    _reset
  ;;

  stop)
    _stop
  ;;

  debug)
    _debug
  ;;

  *)
    _help
  ;;

esac
