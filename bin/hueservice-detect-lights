#! /bin/sh

. /etc/hue-shell/hue-shell.conf

BASENAME=$(basename $0)
PID=$DIR_RUN_TMP/${BASENAME}.pid

_usage() {
	echo "Usage: ${BASENAME} {start|status|stop}" >&2
	exit 3
}

_is_running() {
	kill -0 $(cat $PID) > /dev/null 2>&1
	echo $?
}

_start() {
	if [ "$(_is_running)" = 0 ]; then
		echo "The service is alreading running."
	else
		(
		while true; do
			_hue_get_on > $FILE_LIGHTS_REACHABLE
			sleep $REFRESH_INTERVAL
		done
		) &

		echo $! > $PID
		echo "Starting the service '${BASENAME}'."
		_hue_log 1 "Starting"
	fi
}

_status() {
	if [ "$(_is_running)" = 0 ]; then
		echo "The service '${BASENAME})' is running."
		echo "The reachable lights are: "$(_hue_get_lights_reachable)
	else
		echo "The service '${BASENAME}' is not running."
	fi
}

_stop() {
		_hue_log 1 "Stopping"
		kill $(cat $PID) > /dev/null 2>&1
		echo > $PID
		echo "Stopping the service '${BASENAME}'."

}

case "$1" in
	start) _start ;;
	status) _status ;;
	stop) _stop ;;
	*) _usage ;;
esac

exit 0

# vim: set ts=8 sw=8 sts=8 et :
# sublime: tab_size 8;
