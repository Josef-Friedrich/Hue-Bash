#! /bin/sh

. /etc/hue-shell/hue-shell.conf

PID=$DIR_RUN_TMP/$(basename $0).pid

_usage() {
	echo "Usage: $(basename $0) {start|status|stop}" >&2
	exit 3
}

_is_running() {
	kill -0 $(cat $PID) > /dev/null 2>&1
	echo $?
}

_start() {
	if [ "$(_is_running)" = 0 ]; then
		echo "The service is alreading running."
	else
		(
		while true; do
			_hue_get_on > $DIR_RUN_TMP/all-lights
			sleep $REFRESH_INTERVAL
		done
		) &

		echo $! > $PID
		echo "Starting the service '$(basename $0)'."
	fi
}

_status() {
	if [ "$(_is_running)" = 0 ]; then
		echo "The service '$(basename $0)' is running."
		echo "The reachable lights are: "$(_hue_get_light_ids)
	else
		echo "The service '$(basename $0)' is not running."
	fi
}

_stop() {
		kill $(cat $PID) > /dev/null 2>&1
		echo > $PID
		echo "Stopping the service '$(basename $0)'."
}

case "$1" in
	start) _start ;;
	status) _status ;;
	stop) _stop ;;
	*) _usage ;;
esac

exit 0

# vim: set ts=8 sw=8 sts=8 et :
# sublime: tab_size 8;
