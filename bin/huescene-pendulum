#! /bin/sh

. /etc/hue-shell/hue-shell.conf

# Defaults
COLOR1=$(_hue_range 0:65535)
COLOR2=$(_hue_range 0:65535)
SWITCH_TIME=$(_hue_range 1:10)
TRANSITION_TIME=$(_hue_range 5:50)

_calculate_lights() {
	if [ -n "$LIGHTS1" ] && [ -n "$LIGHTS2" ]; then
		L1="$LIGHTS1"
		L2="$LIGHTS2"
		return
	fi

	LIGHTS=$(_hue_get_lights_reachable)

	if [ ! "$LIGHTS" = '' ]; then

		OLD_IFS=$IFS; IFS=","
		COUNT=1
		for LIGHT in $LIGHTS; do
			IFS=$OLD_IFS

			NUMBER=$(_hue_range 1:2)

			if [ "$COUNT" = 1 ]; then
				L1="$LIGHT"
			elif [ "$COUNT" = 2 ]; then
				L2="$LIGHT"
			elif [ "$NUMBER" = 1 ]; then
				L1="$L1,$LIGHT"
			else
				L2="$L2,$LIGHT"
			fi
			COUNT=$((COUNT + 1))
		done
	else
		L1=0
		L2=0
	fi

}

#	$1: LIGHTS1
#	$2: LIGHTS2
#	$3: COLOR1
#	$4: COLOR2
#	$5: SWITCH_TIME
#	$6: TRANSITION_TIME
_pendulum() {
	if [ ! "$1" = 0 ] && [ ! "$2" = 0 ]; then
		_hue_set $1 --hue $3 -t $6 --sat 255 --bri 255
		_hue_set $2 --hue $4 -t $6 --sat 255 --bri 255

		sleep $5

		_hue_set $2 --hue $3 -t $6 --sat 255 --bri 255
		_hue_set $1 --hue $4 -t $6 --sat 255 --bri 255
		sleep $5
	else
		sleep $(($5 * 2))
	fi
}

while true ; do
	case "$1" in

		-c1|--color1)
			COLOR1=$2
			shift 2
			;;

		-c2|--color2)
			COLOR2=$2
			shift 2
			;;

		-h|--help)
			_hue_usage $BASENAME
			break
			;;

		-l1|--lights1)
			LIGHTS1=$2
			shift 2
			;;

		-l2|--lights2)
			LIGHTS2=$2
			shift 2
			;;

		-s|--switchtime)
			SWITCH_TIME=$2
			shift 2
			;;

		-t|--transitiontime)
			TRANSITION_TIME=$2
			shift 2
			;;

		*)
			break
			;;
	esac
done

_hue_trap
_hue_stop

_hue_log 1 "COLOR1: ${COLOR1} \
COLOR2: ${COLOR2} \
SWITCH_TIME: ${SWITCH_TIME} \
TRANSITION_TIME: ${TRANSITION_TIME}"

while true; do
	_calculate_lights
	_hue_log 2 "LIGHTS1: $L1 LIGHTS2: $L2"
	_pendulum $L1 $L2 $COLOR1 $COLOR2 $SWITCH_TIME $TRANSITION_TIME
done

# vim: set ts=8 sw=8 sts=8 et :
# sublime: tab_size 8;