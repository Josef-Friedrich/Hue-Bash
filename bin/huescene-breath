#! /bin/sh

. /etc/hue-shell/hue-shell.conf

# Helper function.
#	$1: LIGHT
#	$2: HUE_RANGE
#	$3: TIME_RANGE
#	$4: BRI_RANGE
_breath() {
	local TRANSTIME=$(_hue_range $3)
	local BRI_START=${4%%:*}
	local BRI_END=${4#*:}

	_hue_set_transit $1 $TRANSTIME --hue $(_hue_range $2) --bri $BRI_END --sat 255
	_hue_set_transit $1 $TRANSTIME --bri $BRI_START
}

while true ; do
	case "$1" in
		-b|--brightness-range)
			BRI_RANGE=$2
			shift 2
			;;

		-h|--help)
			_hue_usage $(basename $0)
			break
			;;

		-H|--hue-range)
			HUE_RANGE=$2
			shift 2
			;;

		-l|--lights)
			LIGHTS_INPUT=$2
			shift 2
			;;

		-m|--master-pid)
			MASTER_PID=$2
			shift 2
			;;

		-t|--time-range)
			TIME_RANGE=$2
			shift 2
			;;

		*)
			break
			;;
	esac
done

# Default values.
if [ -z "$HUE_RANGE" ]; then
	HUE_RANGE="$(_hue_range 0:32766):$(_hue_range 32767:65535)"
fi

if [ -z "$TIME_RANGE" ]; then
	TIME_RANGE="$(_hue_range 1:4):$(_hue_range 5:8)"
fi

if [ -z "$BRI_RANGE" ]; then
	BRI_RANGE="$(_hue_range 1:100):$(_hue_range 100:255)"
fi

if [ -z $LIGHTS_INPUT ] && [ -n $ALL_LIGHTS ]; then
	LIGHTS=$ALL_LIGHTS
fi

LIGHTS_CONF=$ALL_LIGHTS

_loop_breath() {
	eval HAS_PID=\$PID${LIGHT}
	eval IS_REACHABLE=\$REACHABLE${LIGHT}

	# -n STRING: the length of STRING is nonzero
	# -z STRING: the length of STRING is zero

	# Start lights
	# -z "$HAS_PID": has no PID
	# -n "$IS_REACHABLE": is reachable
	if [ -z "$HAS_PID" ] && [ -n "$IS_REACHABLE" ]; then
		(
			while true; do
				_breath $LIGHT $HUE_RANGE $TIME_RANGE $BRI_RANGE
			done
		) &
		if [ -n "$MASTER_PID" ]; then
			_hue_write_to_master_pid $MASTER_PID $!
		fi
		eval PID${LIGHT}=$!
	fi

	# Stop lights
	# -n "$HAS_PID": has PID
	# -z "$IS_REACHABLE": is not reachable
	if [ -n "$HAS_PID" ] && [ -z "$IS_REACHABLE" ]; then
		eval kill \$PID${LIGHT}
		eval PID${LIGHT}=''
	fi
}

_kill_all() {
	OLD_IFS=$IFS; IFS=","
	for LIGHT in $LIGHTS_REACHABLE ; do
		IFS=$OLD_IFS
		eval kill \$PID${LIGHT} > /dev/null 2>&1
	done
}

_detect_lights() {
	LIGHTS_REACHABLE="$(_hue_get_lights_reachable)"

	# Unset all REACHABLEX variables
	OLD_IFS=$IFS; IFS=","
	for LIGHT in $LIGHTS_ALL ; do
		IFS=$OLD_IFS
		eval REACHABLE${LIGHT}=''
	done

	# Create for each reachable Light X a variable: REACHABLEX
	OLD_IFS=$IFS; IFS=","
	for LIGHT in $LIGHTS_REACHABLE ; do
		IFS=$OLD_IFS
		eval REACHABLE${LIGHT}=1
	done

	OLD_IFS=$IFS; IFS=","
	for LIGHT in $LIGHTS_ALL ; do
		IFS=$OLD_IFS
		_loop_breath
	done
}

# We can not use the _hue_trap function from the library
_hue_trap "_kill_all; _hue_reset; echo; exit"
_hue_stop

if [ -n "$MASTER_PID" ]; then
	_hue_write_to_master_pid $MASTER_PID $$
fi

if [ "$DEBUG" -ge 1 ]; then
	echo "HUE_RANGE: $HUE_RANGE"
	echo "TIME_RANGE: $TIME_RANGE"
	echo "BRI_RANGE: $BRI_RANGE"
	echo "LIGHTS: $LIGHTS_ALL"
fi

while true; do
	_detect_lights
	sleep $REFRESH_INTERVAL
done

# vim: set ts=8 sw=8 sts=8 et :
# sublime: tab_size 8;